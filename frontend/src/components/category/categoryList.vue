<template>
  <div class="container">
      <h3>Categories List</h3>
      <b-button @click="showCreateModal()" variant="info">Create</b-button>
      <b-alert variant="success" :show="showSuccessAlert" dismissible>Category was created successfully.</b-alert>
      <b-alert variant="info" :show="showInfoAlert" dismissible>Category was updated successfully.</b-alert>
      <b-alert variant="warning" :show="showWarningAlert" dismissible>Category was deleted successfully.</b-alert>
    <b-row>
      <b-col cols="9">
        <b-row>
          <b-table :items="categories" :fields="fields" responsive primary-key="id">
            <template v-slot:cell(cat_type)="data">
              <p>{{ getCategory(data.value) }}</p>
            </template>
            <template v-slot:cell(actions)="data">
              <b-button @click="showEditModal(data.item.id)" variant="warning" size="sm">Edit</b-button>&nbsp;
              <b-button @click="showDeleteModal(data.item.id)" variant="danger" size="sm">Delete</b-button>
            </template>
          </b-table>
        </b-row>
        <b-row>
          <paginateNav :property="'categories'" @set-page-request="setPaginationRequest" />
        </b-row>
      </b-col>
      <b-col cols="3">
        <filtrationSidebar/>
      </b-col>
    </b-row>
    <b-modal 
      id="categoryForm" 
      :title="modalTitle" 
      hide-footer no-close-on-backdrop>
      <categoryForm 
        :action="action" 
        :categoryId="categoryId"
        @showSuccessAlert="showSuccessAlert=true"
        @showInfoAlert="showInfoAlert=true"/>
    </b-modal>
    <b-modal 
      id="deleteCategory" 
      title="Delete Category" 
      ok-title="Delete" 
      @ok="onDelete(categoryId)">
      <p>Are you sure you want to delete the category?</p>
    </b-modal>
  </div>
</template>

<script>

import { mapGetters } from 'vuex';

import categoryForm from '@/components/category/categoryForm.vue';
import filtrationSidebar from '@/components/category/filtrationSidebar.vue';
import paginateNav from '@/components/paginate.vue';

export default {
  name: 'categoryList',
  components: {
    categoryForm,
    filtrationSidebar,
    paginateNav,
  },
  data() {
    return {
      categoryId: null,
        action: '',
        modalTitle: '',
        fields: [
          'name',
          {key: 'cat_type', label: 'Category Type'},
          'actions',
        ],
        showSuccessAlert: false,
        showInfoAlert: false,
        showWarningAlert: false,
    };
  },
  computed: {
    accountsFilters() {
      return this.$store.getters.filter.categories;
    },
    accountsSearch() {
      return this.$store.getters.search.categories;
    },
    ...mapGetters([
        'categories',
    ]),
  },
  methods: {
    onDelete(categoryId) {
      this.$store.dispatch('deleteCategory', categoryId)
        .then(() => {
          this.showWarningAlert=true;
        })
    },
    setPaginationRequest(page) {
      const params = { params: {
        page: page,
        ...this.categoriesFilters,
        search: this.categoriesSearch,
      }};
      this.$store.dispatch('getCategories', params);
    },
    showCreateModal() {
      this.action = 'create';
      this.modalTitle = 'Create Category'
      this.$bvModal.show('categoryForm');
    },
    showEditModal(categoryId) {
      this.action = 'update';
      this.categoryId = categoryId;
      this.modalTitle = 'Edit Category'
      this.$bvModal.show('categoryForm');
    },
    showDeleteModal(categoryId) {
      this.categoryId = categoryId;
      this.$bvModal.show('deleteCategory');
    },
    getCategory(cat_value) {
      if (cat_value === 'INC') {
        return 'Income';
      } else if (cat_value === 'EXP') {
        return 'Expences';
      } else {
        return 'Technical';
      }
    },
  },

  beforeMount() {
    this.$store.dispatch('getCategories');
  },  
}
</script>
